---
title: "NCHA Data Transformation and Quality Checks"
runningheader: "DeYoung et al. 2020" # only for pdf output
subtitle: "Preliminary Examination of NSDUH Outcomes" # only for html output
author: "Matthew Barstead, Ph.D."
date: "`r Sys.Date()`"
output:
  tufte::tufte_handout:
    includes: 
      in_header: preamble.tex
    highlight: tango
  tufte::tufte_html: default
  tufte::tufte_book:
    highlight: tango
  pdf_document:
    includes: 
      in_header: preamble.tex
bibliography: NCHA_data_QA.bib
nocite: '@*'
---

```{r setup, include=FALSE}
library(glue)
library(tidyverse)
source('~/github/ATNL/grad_mh/project_config.R')
sapply(list.files(R_DIR, full.names = TRUE), source)
load('{DATA_DIR}/NCHA-II/ncha_study_data.RData' %>% glue())
```

# Dependent Variables^[**IMPORTANT**: The focus is on successful re-coding of data and therefore this document evaluates data processing outcomes on the entire NCHA sample - undergraduates and graduates]

The NCHA data set contains three sets of "outcome" variables: recency of emotional distress, suicidality and self-harm, and diagnosis/treatment of mental health disorders in the past year. For the first two outcome sets, the following wording and response options were used: 

_Have you ever_:

Emotional Distress

- Felt things were hopeless 
- Felt overwhelmed by all you had to do
- Felt exhausted (not from physical activity)
- Felt very lonely
- Felt so depressed that it was difficult to function
- Felt overwhelming anxiety
- Felt overwhelming anger

Suicide and Self-Harm

- Intentionally cut, burned, bruised, or otherwise injured yourself
- Seriously considered suicide
- Attempted suicide

The response options for these items was^[Note that the original codes in the data do not create a logically consistent ordinal structure. Part of the re-coding work being evaluated in this document is the effectiveness of re-coding these scales so that values of 1 to 5 move from least recent (*No, Never*) to most recent (*Yes, in the last 2 weeks*): 

1. No, never
2. No, not in the last 12 months
3. Yes, in the last 2 weeks
4. Yes, in the last 30 days
5. Yes, in the last 12 months

For the diagnosis and treatment measures respondents were asked the following: 

_Within the last 12 months, have you been diagnosed or treated by a professional for any of the following?_ 

- Anoxeria
- Anxiety
- Attention Deficit and Hyperactivity Disorder (ADHD)
- Bipolar Disorder
- Bulimia
- Depression
- Insomnia
- Other sleep disorder
- Obsessive Compulsive Disorder
- Panic attacks
- Phobia
- Schizophrenia
- Substance abuse or addiction (alcohol or other drugs)
- Other addiction (e.g., gambling, internet, sexual)
- Other mental health condition

The response options for this item set were: 

1. No
2. Yes, diagnosed but not treated
3. Yes, treated with medication
4. Yes, treated with psychotherapy
5. Yes, treated with medication and psychotherapy
6. Yes, other treatment

The remainder of this section will be devoted to examining the re-coded variables with respect to the original variables to ensure that the correct logic was enforced when the transformations were applied. For the first two sets of variables (emotional distress and suicidality/self-harm), the original ordinal scales needed to be re-arranged first, and then a series of dichotomous indicators was created based the re-ordered variables. For the second set (diagnosis/treatment), no intermediate re-coding steps were required prior to dichotomization^[We chose to dichotomize the diagnosis and treatment of specific mental health disorders within the past year to maximize comparability with the NSDUH data set. Two of the suicide items also become more comparable making a similar dichotomization. The remainder of the emotional distress items (e.g., _very lonely_, _overwhelming anxiety_, etc.) do not have a NSDUH variable to compare against. The only benefit of dichotomizing these variables is model structure consistency. We should consider at the very least adding a series of ordinal regressions (using a cumulative link function) for these variables.]

## Felt things were hopeless (`NQ30A`)

New variables: 

- `Q30A_hopeless`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30A_hopeless_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30A_hopeless_r_2wks`: a binary (0, 1) variable generated from `Q30A_hopeless_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30A_hopeless_r_30days`: a binary (0, 1) variable generated from `Q30A_hopeless_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.^[There may be an opportunity to make _some_ limited comparisons using a set of "30-day" variables with transformations of some of the Kessler 6 scores available in the NSDUH data set.]
- `Q30A_hopeless_r_12mos`: a binary (0, 1) variable generated from `Q30A_hopeless_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30A_hopeless`**

```{r, results='asis'}
original_var <- "NQ30A"
new_var <- "Q30A_hopeless"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
# Error is raised and render fails on test failure
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30A_hopeless_r`**^[The new variable is labelled with the new positional order which you can see in the columnwise left-to-right order.]

```{r, results='asis'}
new_var <- "Q30A_hopeless_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30A_hopeless_r_2wks`**

```{r, results='asis'}
original_var <- "Q30A_hopeless_r"
new_var <- "Q30A_hopeless_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30A_hopeless_r_30days`**

```{r, results='asis'}
new_var <- "Q30A_hopeless_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30A_hopeless_r_12mos`**

```{r, results='asis'}
new_var <- "Q30A_hopeless_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Felt overwhelmed by all you had to do (`NQ30B`)

New variables: 

- `Q30B_overwhelmed`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30B_overwhelmed_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30B_overwhelmed_r_2wks`: a binary (0, 1) variable generated from `Q30B_overwhelmed_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30B_overwhelmed_r_30days`: a binary (0, 1) variable generated from `Q30B_overwhelmed_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30B_overwhelmed_r_12mos`: a binary (0, 1) variable generated from `Q30B_overwhelmed_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30B_overwhelmed`**

```{r, results='asis'}
original_var <- "NQ30B"
new_var <- "Q30B_overwhelmed"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30B_overwhelmed_r`**

```{r, results='asis'}
new_var <- "Q30B_overwhelmed_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30B_overwhelmed_r_2wks`**

```{r, results='asis'}
original_var <- "Q30B_overwhelmed_r"
new_var <- "Q30B_overwhelmed_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30B_overwhelmed_r_30days`**

```{r, results='asis'}
new_var <- "Q30B_overwhelmed_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30B_overwhelmed_r_12mos`**

```{r, results='asis'}
new_var <- "Q30B_overwhelmed_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Felt exhausted (not from physical activity) (`NQ30C`)

New variables: 

- `Q30C_exhausted`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30C_exhausted_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30C_exhausted_r_2wks`: a binary (0, 1) variable generated from `Q30C_exhausted_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30C_exhausted_r_30days`: a binary (0, 1) variable generated from `Q30C_exhausted_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30C_exhausted_r_12mos`: a binary (0, 1) variable generated from `Q30C_exhausted_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30C_exhausted`**

```{r, results='asis'}
original_var <- "NQ30C"
new_var <- "Q30C_exhausted"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30C_exhausted_r`**

```{r, results='asis'}
new_var <- "Q30C_exhausted_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30C_exhausted_r_2wks`**

```{r, results='asis'}
original_var <- "Q30C_exhausted_r"
new_var <- "Q30C_exhausted_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30C_exhausted_r_30days`**

```{r, results='asis'}
new_var <- "Q30C_exhausted_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30C_exhausted_r_12mos`**

```{r, results='asis'}
new_var <- "Q30C_exhausted_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Felt very lonely (`NQ30D`)

New variables: 

- `Q30D_lonely`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30D_lonely_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30D_lonely_r_2wks`: a binary (0, 1) variable generated from `Q30D_lonely_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30D_lonely_r_30days`: a binary (0, 1) variable generated from `Q30D_lonely_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30D_lonely_r_12mos`: a binary (0, 1) variable generated from `Q30D_lonely_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30D_lonely`**

```{r, results='asis'}
original_var <- "NQ30D"
new_var <- "Q30D_lonely"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30D_lonely_r`**

```{r, results='asis'}
new_var <- "Q30D_lonely_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30D_lonely_r_2wks`**

```{r, results='asis'}
original_var <- "Q30D_lonely_r"
new_var <- "Q30D_lonely_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30D_lonely_r_30days`**

```{r, results='asis'}
new_var <- "Q30D_lonely_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30D_lonely_r_12mos`**

```{r, results='asis'}
new_var <- "Q30D_lonely_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Felt very sad (`NQ30E`)

New variables: 

- `Q30E_sad`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30E_sad_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30E_sad_r_2wks`: a binary (0, 1) variable generated from `Q30E_sad_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30E_sad_r_30days`: a binary (0, 1) variable generated from `Q30E_sad_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30E_sad_r_12mos`: a binary (0, 1) variable generated from `Q30E_sad_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30E_sad`**

```{r, results='asis'}
original_var <- "NQ30E"
new_var <- "Q30E_sad"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30E_sad_r`**

```{r, results='asis'}
new_var <- "Q30E_sad_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30E_sad_r_2wks`**

```{r, results='asis'}
original_var <- "Q30E_sad_r"
new_var <- "Q30E_sad_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30E_sad_r_30days`**

```{r, results='asis'}
new_var <- "Q30E_sad_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30E_sad_r_12mos`**

```{r, results='asis'}
new_var <- "Q30E_sad_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```


## Felt so depressed that it was difficult to function (`NQ30F`)

New variables: 

- `Q30F_depressed`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30F_depressed_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30F_depressed_r_2wks`: a binary (0, 1) variable generated from `Q30F_depressed_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30F_depressed_r_30days`: a binary (0, 1) variable generated from `Q30F_depressed_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30F_depressed_r_12mos`: a binary (0, 1) variable generated from `Q30F_depressed_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30F_depressed`**

```{r, results='asis'}
original_var <- "NQ30F"
new_var <- "Q30F_depressed"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30F_depressed_r`**

```{r, results='asis'}
new_var <- "Q30F_depressed_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30F_depressed_r_2wks`**

```{r, results='asis'}
original_var <- "Q30F_depressed_r"
new_var <- "Q30F_depressed_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30F_depressed_r_30days`**

```{r, results='asis'}
new_var <- "Q30F_depressed_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30F_depressed_r_12mos`**

```{r, results='asis'}
new_var <- "Q30F_depressed_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Felt overwhelming anxiety (`NQ30G`)

New variables: 

- `Q30G_anxiety`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30G_anxiety_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30G_anxiety_r_2wks`: a binary (0, 1) variable generated from `Q30G_anxiety_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30G_anxiety_r_30days`: a binary (0, 1) variable generated from `Q30G_anxiety_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30G_anxiety_r_12mos`: a binary (0, 1) variable generated from `Q30G_anxiety_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30G_anxiety`**

```{r, results='asis'}
original_var <- "NQ30G"
new_var <- "Q30G_anxiety"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30G_anxiety_r`**

```{r, results='asis'}
new_var <- "Q30G_anxiety_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30G_anxiety_r_2wks`**

```{r, results='asis'}
original_var <- "Q30G_anxiety_r"
new_var <- "Q30G_anxiety_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30G_anxiety_r_30days`**

```{r, results='asis'}
new_var <- "Q30G_anxiety_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30G_anxiety_r_12mos`**

```{r, results='asis'}
new_var <- "Q30G_anxiety_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Felt overwhelming anger (`NQ30H`)

New variables: 

- `Q30H_anger`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30H_anger_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30H_anger_r_2wks`: a binary (0, 1) variable generated from `Q30H_anger_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30H_anger_r_30days`: a binary (0, 1) variable generated from `Q30H_anger_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30H_anger_r_12mos`: a binary (0, 1) variable generated from `Q30H_anger_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30H_anger`**

```{r, results='asis'}
original_var <- "NQ30H"
new_var <- "Q30H_anger"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30H_anger_r`**

```{r, results='asis'}
new_var <- "Q30H_anger_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30H_anger_r_2wks`**

```{r, results='asis'}
original_var <- "Q30H_anger_r"
new_var <- "Q30H_anger_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30H_anger_r_30days`**

```{r, results='asis'}
new_var <- "Q30H_anger_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30H_anger_r_12mos`**

```{r, results='asis'}
new_var <- "Q30H_anger_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Intentionally cut, burned, bruised, or otherwise injured yourself (`NQ30I`)

New variables: 

- `Q30I_selfharm`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30I_selfharm_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30I_selfharm_r_2wks`: a binary (0, 1) variable generated from `Q30I_selfharm_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30I_selfharm_r_30days`: a binary (0, 1) variable generated from `Q30I_selfharm_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30I_selfharm_r_12mos`: a binary (0, 1) variable generated from `Q30I_selfharm_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30I_selfharm`**

```{r, results='asis'}
original_var <- "NQ30I"
new_var <- "Q30I_selfharm"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30I_selfharm_r`**

```{r, results='asis'}
new_var <- "Q30I_selfharm_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30I_selfharm_r_2wks`**

```{r, results='asis'}
original_var <- "Q30I_selfharm_r"
new_var <- "Q30I_selfharm_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30I_selfharm_r_30days`**

```{r, results='asis'}
new_var <- "Q30I_selfharm_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30I_selfharm_r_12mos`**

```{r, results='asis'}
new_var <- "Q30I_selfharm_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Seriously considered suicide (`NQ30J`)

New variables: 

- `Q30J_suic_thnk`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30J_suic_thnk_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30J_suic_thnk_r_2wks`: a binary (0, 1) variable generated from `Q30J_suic_thnk_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30J_suic_thnk_r_30days`: a binary (0, 1) variable generated from `Q30J_suic_thnk_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30J_suic_thnk_r_12mos`: a binary (0, 1) variable generated from `Q30J_suic_thnk_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30J_suic_thnk`**

```{r, results='asis'}
original_var <- "NQ30J"
new_var <- "Q30J_suic_thnk"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30J_suic_thnk_r`**

```{r, results='asis'}
new_var <- "Q30J_suic_thnk_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30J_suic_thnk_r_2wks`**

```{r, results='asis'}
original_var <- "Q30J_suic_thnk_r"
new_var <- "Q30J_suic_thnk_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30J_suic_thnk_r_30days`**

```{r, results='asis'}
new_var <- "Q30J_suic_thnk_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30J_suic_thnk_r_12mos`**

```{r, results='asis'}
new_var <- "Q30J_suic_thnk_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Attempted suicide(`NQ30K`)

New variables: 

- `Q30K_suic_try`: factor with 5 numeric levels corresponding to the response options in the original rank order.
- `Q30K_suic_try_r`: factor with 5 numeric levels and labels that are ordinally ranked from least recent to most recent response option along the 1 - 5 scale
- `Q30K_suic_try_r_2wks`: a binary (0, 1) variable generated from `Q30K_suic_try_r`. If the respondent indicated they had felt this form of distress in the past two weeks they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing. 
- `Q30K_suic_try_r_30days`: a binary (0, 1) variable generated from `Q30K_suic_try_r`. If the respondent indicated they had felt this form of distress in the past two weeks or in the past thirty days they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.
- `Q30K_suic_try_r_12mos`: a binary (0, 1) variable generated from `Q30K_suic_try_r`. If the respondent indicated they had felt this form of distress in the past two weeks, in the past thirty days, or in the past twelve months they were assigned a 1. Otherwise a zero. Missing values should be preserved as missing.

We'll focus mainly on crosstabs and preservation of missing values as evidence of successful transformations. 

**`Q30K_suic_try`**

```{r, results='asis'}
original_var <- "NQ30K"
new_var <- "Q30K_suic_try"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30K_suic_try_r`**

```{r, results='asis'}
new_var <- "Q30K_suic_try_r"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30K_suic_try_r_2wks`**

```{r, results='asis'}
original_var <- "Q30K_suic_try_r"
new_var <- "Q30K_suic_try_r_2wks"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30K_suic_try_r_30days`**

```{r, results='asis'}
new_var <- "Q30K_suic_try_r_30days"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q30K_suic_try_r_12mos`**

```{r, results='asis'}
new_var <- "Q30K_suic_try_r_12mos"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for anoxeria in past 12 months (`NQ31A1`)

New variables: 

- `Q31A_anorexia`: character variable containing 6 possible categorical response options as strings. 
- `Q31A_anorexia_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31A_anorexia`**^[Orientation of the tables changed in this section to accommodate more and longer response options]

```{r, results='asis'}
original_var <- "NQ31A1"
new_var <- "Q31A_anorexia"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31A_anorexia_dich`**

```{r, results='asis'}
original_var <- "Q31A_anorexia"
new_var <- "Q31A_anorexia_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```


## Diagnosed with or treated for anxiety in past 12 months (`NQ31A2`)

New variables: 

- `Q31A_anxiety`: character variable containing 6 possible categorical response options as strings. 
- `Q31A_anxiety_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31A_anxiety`**

```{r, results='asis'}
original_var <- "NQ31A2"
new_var <- "Q31A_anxiety"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31A_anxiety_dich`**

```{r, results='asis'}
original_var <- "Q31A_anxiety"
new_var <- "Q31A_anxiety_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for ADHD in past 12 months (`NQ31A3`)

New variables: 

- `Q31A_adhd`: character variable containing 6 possible categorical response options as strings. 
- `Q31A_adhd_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31A_adhd`**

```{r, results='asis'}
original_var <- "NQ31A3"
new_var <- "Q31A_adhd"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31A_adhd_dich`**

```{r, results='asis'}
original_var <- "Q31A_adhd"
new_var <- "Q31A_adhd_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for bipolar disorder in past 12 months (`NQ31A4`)

New variables: 

- `Q31A_bipolar`: character variable containing 6 possible categorical response options as strings. 
- `Q31A_bipolar_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31A_bipolar`**

```{r, results='asis'}
original_var <- "NQ31A4"
new_var <- "Q31A_bipolar"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31A_bipolar_dich`**

```{r, results='asis'}
original_var <- "Q31A_bipolar"
new_var <- "Q31A_bipolar_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for bulimia in past 12 months (`NQ31A5`)

New variables: 

- `Q31A_bulimia`: character variable containing 6 possible categorical response options as strings. 
- `Q31A_bulimia_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31A_bulimia`**

```{r, results='asis'}
original_var <- "NQ31A5"
new_var <- "Q31A_bulimia"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31A_bulimia_dich`**

```{r, results='asis'}
original_var <- "Q31A_bulimia"
new_var <- "Q31A_bulimia_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for depression in past 12 months (`NQ31A6`)

New variables: 

- `Q31A_depression`: character variable containing 6 possible categorical response options as strings. 
- `Q31A_depression_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31A_depression`**

```{r, results='asis'}
original_var <- "NQ31A6"
new_var <- "Q31A_depression"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31A_depression_dich`**

```{r, results='asis'}
original_var <- "Q31A_depression"
new_var <- "Q31A_depression_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for insomnia in past 12 months (`NQ31A7`)

New variables: 

- `Q31A_insomnia`: character variable containing 6 possible categorical response options as strings. 
- `Q31A_insomnia_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31A_insomnia`**

```{r, results='asis'}
original_var <- "NQ31A7"
new_var <- "Q31A_insomnia"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31A_insomnia_dich`**

```{r, results='asis'}
original_var <- "Q31A_insomnia"
new_var <- "Q31A_insomnia_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for other sleep disorders in past 12 months (`NQ31A8`)

New variables: 

- `Q31A_othrsleep`: character variable containing 6 possible categorical response options as strings. 
- `Q31A_othrsleep_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31A_othrsleep`**

```{r, results='asis'}
original_var <- "NQ31A8"
new_var <- "Q31A_othrsleep"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31A_othrsleep_dich`**

```{r, results='asis'}
original_var <- "Q31A_othrsleep"
new_var <- "Q31A_othrsleep_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for obssessive compulsive disorder in past 12 months (`NQ31B1`)

New variables: 

- `Q31B_ocd`: character variable containing 6 possible categorical response options as strings. 
- `Q31B_ocd_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31B_ocd`**

```{r, results='asis'}
original_var <- "NQ31B1"
new_var <- "Q31B_ocd"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31B_ocd_dich`**

```{r, results='asis'}
original_var <- "Q31B_ocd"
new_var <- "Q31B_ocd_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for panic attacks in past 12 months (`NQ31B2`)

New variables: 

- `Q31B_panic`: character variable containing 6 possible categorical response options as strings. 
- `Q31B_panic_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31B_panic`**

```{r, results='asis'}
original_var <- "NQ31B2"
new_var <- "Q31B_panic"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31B_panic_dich`**

```{r, results='asis'}
original_var <- "Q31B_panic"
new_var <- "Q31B_panic_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for phobia in past 12 months (`NQ31B3`)

New variables: 

- `Q31B_phobia`: character variable containing 6 possible categorical response options as strings. 
- `Q31B_phobia_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31B_phobia`**

```{r, results='asis'}
original_var <- "NQ31B3"
new_var <- "Q31B_phobia"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31B_phobia_dich`**

```{r, results='asis'}
original_var <- "Q31B_phobia"
new_var <- "Q31B_phobia_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for schizophreniain past 12 months (`NQ31B4`)

New variables: 

- `Q31B_schizo`: character variable containing 6 possible categorical response options as strings. 
- `Q31B_schizo_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31B_schizo`**

```{r, results='asis'}
original_var <- "NQ31B4"
new_var <- "Q31B_schizo"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31B_schizo_dich`**

```{r, results='asis'}
original_var <- "Q31B_schizo"
new_var <- "Q31B_schizo_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for substance use or addiction in past 12 months (`NQ31B5`)

New variables: 

- `Q31B_substance`: character variable containing 6 possible categorical response options as strings. 
- `Q31B_substance_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31B_substance`**

```{r, results='asis'}
original_var <- "NQ31B5"
new_var <- "Q31B_substance"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31B_substance_dich`**

```{r, results='asis'}
original_var <- "Q31B_substance"
new_var <- "Q31B_substance_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for other addictions in past 12 months (`NQ31B6`)

New variables: 

- `Q31B_othraddctn`: character variable containing 6 possible categorical response options as strings. 
- `Q31B_othraddctn_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31B_othraddctn`**

```{r, results='asis'}
original_var <- "NQ31B6"
new_var <- "Q31B_othraddctn"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31B_othraddctn_dich`**

```{r, results='asis'}
original_var <- "Q31B_othraddctn"
new_var <- "Q31B_othraddctn_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Diagnosed with or treated for obssessive compulsive disorder in past 12 months (`NQ31B7`)

New variables: 

- `Q31B_othrmnthlth`: character variable containing 6 possible categorical response options as strings. 
- `Q31B_othrmnthlth_dich`: a binary (0, 1) variable where 1 is assigned to any case with an affirmative response to either diagnosis with or treatment for the disorder in the past 12 months. Otherwise the case is assigned a 0. Missing values should be retained as missing.

**`Q31B_othrmnthlth`**

```{r, results='asis'}
original_var <- "NQ31B7"
new_var <- "Q31B_othrmnthlth"
create_latex_crosstabs(complete_df, new_var, original_var)
```
```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q31B_othrmnthlth_dich`**

```{r, results='asis'}
original_var <- "Q31B_othrmnthlth"
new_var <- "Q31B_othrmnthlth_dich"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

\pagebreak

# Independent Variables/Covariates 

The core property of interest in any models built using these data will be change in the dependent variables over time. Whatever properties of change we uncover - change will not have taken place in a vacuum. There are likely relevant individual- and school-level factors that have shaped change processes over time - or at least can improve the precision with which we can define change processes in our models. 

Compared to the dependent variables, our set of covariates have been minimally processed. The biggest challenge was aligning demographic variables across the three versions of the NCHA deployed from 2008 to 2019. See the race/ethnicity and gender variables for more detail. 

## Race Ethnicity (`NQ54*`)

The basic design of the race/ethnicity variables did not change across the 3 studies. In each survey, respondents could select all racial/ethnic categories they believed applied to them. What did change across the studies was the specific wording associated with each racial/ethnic response option. 

The Fall 2008 to Spring 2011 survey requested participants select all of the following that applied^[Responses were coded as a 1 if the corresponding box was checked off on the survey and 0 otherwise.]: 

- `NQ54A`: White, non Hispanic (includes Middle Eastern)
- `NQ54B`: Black, non Hispanic 
- `NQ54C`: Hispanic or Latino/a 
- `NQ54D`: Asian or Pacific Islander
- `NQ54E`: American Indian, Alaskan Native, or Native Hawaiian
- `NQ54F`: Biracial or Multiracial
- `NQ54G`: Other

In the Fall 2011 to Spring 2015 survey, the first two options changed slightly in their wording: 

- `NQ54A`: White
- `NQ54B`: Black 

We chose to treat these two categories as equivalent across the studies. We created a renamed version of each race/ethnicity variable - mainly to add more explicit semantic mappings for each column in the data set. No other transformations took place. 

New Variables: 

- `Q54_white`: a binary (0, 1) non-exclusive indicator. Participants were coded as 1 if they selected either "White, non Hispanic" (Fall 2008 to Spring 2011) or "White" (Fall 2011 - Spring 2019). Otherwise they received a 0. 
- `Q54_black`: a binary (0, 1) non-exclusive indicator. Participants were coded as 1 if they selected either "Black, non Hispanic" (Fall 2008 to Spring 2011) or "Black" (Fall 2011 - Spring 2019). Otherwise they received a 0.
- `Q54_hispanic`: a binary (0, 1) non-exclusive indicator. Participants were coded as 1 if they selected "Hispanic or Latino/a". Otherwise they received a 0.
- `Q54_asian`: a binary (0, 1) non-exclusive indicator. Participants were coded as 1 if they selected "Asian or Pacific Islander". Otherwise they received a 0.
- `Q54_native`: a binary (0, 1) non-exclusive indicator. Participants were coded as 1 if they selected "American Indian, Alaskan Native, or Native Hawaiian". Otherwise they received a 0.
- `Q54_biracial`: a binary (0, 1) non-exclusive indicator. Participants were coded as 1 if they selected "Biracial or Multiracial". Otherwise they received a 0.
- `Q54_other`: a binary (0, 1) non-exclusive indicator. Participants were coded as 1 if they selected "Other". Otherwise, they received a 0.

**`Q54_white`**
```{r, results='asis'}
original_var <- "NQ54A"
new_var <- "Q54_white"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q54_black`**
```{r, results='asis'}
original_var <- "NQ54B"
new_var <- "Q54_black"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q54_hispanic`**
```{r, results='asis'}
original_var <- "NQ54C"
new_var <- "Q54_hispanic"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q54_asian`**
```{r, results='asis'}
original_var <- "NQ54D"
new_var <- "Q54_asian"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q54_native`**
```{r, results='asis'}
original_var <- "NQ54E"
new_var <- "Q54_native"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q54_biracial`**
```{r, results='asis'}
original_var <- "NQ54F"
new_var <- "Q54_biracial"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`Q54_other`**
```{r, results='asis'}
original_var <- "NQ54G"
new_var <- "Q54_other"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Gender (`NQ47`; `RNQ47A` & `RNQ47B`)

Like race and ethnicity, measures of gender were not consistent across all three surveys. In the Fall 2008 to Spring 2011 survey, gender was measured with a single four-response item: _What is your gender?_ (`NQ47`). Options included ("Female", "Male", and "Transgender"). This same item was used again in the Fall 2011 to Spring 2015 survey. 

The measurement of sex, gender, and sexual orientation changed considerably in the Fall 2015 to Spring 2019 survey. In this most recent survey, respondents were first asked to report their biological sex (`RNQ47A`). The very next item (`RNQ47B`) asked whether they "identified" as transgender. 

Fortunately, we can reasonably combine these two measures to create an equivalent measure of gender across all three survey data sets. If a respondent indicated that they did identify as transgender, they were assigned to that category in the "global" `Q47_gender` variable. If they did not, they were assigned a gender value based on their reported biological sex. 

The crosstabs below compare raw and transformed data for the first two equivalent survey designs separately from the revised version more recently used. 

**`NQ47`** vs. **`Q47_gender`** (F08-S11 and F11-S15)

```{r, results='asis', message=FALSE, warning=FALSE}
# 2008 - 2011 data 
ncha_F08_S11 <- load_and_prep_NCHA_file(
  "{DATA_DIR}/NCHA-II/NCHA-II_F08_S11.sav" %>% glue()
)
ncha_F08_S11_df_list <- create_study_datasets(
  ncha_F08_S11, 
  '{MAPS_DIR}/NCHA_map_2008to2011.yaml' %>% glue()
)

original_var <- "NQ47"
new_var <- "Q47_gender"
create_latex_crosstabs(
  data.frame(
    NQ47 = ncha_F08_S11_df_list[['base_df']][[original_var]], 
    Q47_gender = ncha_F08_S11_df_list[['study_df']][[new_var]]
  ), 
  original_var, new_var
)
```

Unfortunately, we will get an error when attempting to compare missingness between the original variable and the transformed one that will be used in this study. There will be exactly four observations that are `NA` in one vector but not in the other. This is the result of an unknown data error in which there are 4 cases with a value of "4" as their response to `NQ47`. The problem is that there is no valid fourth response option. In the re-coded variable that will be used in our models (`Q47_gender`) these cases will be assigned a missing value - hence the conflict. 

With the exception of this minor, but explainable, difference, the re-coded values match for the Fall 2008 to Spring 2011 survey period.
```{r, results='asis', message=FALSE, warning=FALSE}
stargazer::stargazer(
  table(ncha_F08_S11_df_list[['base_df']][[original_var]]) %>% 
    data.frame(), 
  column.sep.width = "1pt", 
  font.size = "footnotesize", 
  summary = FALSE, 
  header = FALSE, 
  rownames = FALSE
)
```

```{r, results='asis', message=FALSE, warning=FALSE}
# 2011 - 2015 data 
ncha_F11_S15 <- load_and_prep_NCHA_file(
  "{DATA_DIR}/NCHA-II/NCHA-II_F11_S15.sav" %>% glue()
)
ncha_F11_S15_df_list <- create_study_datasets(
  ncha_F11_S15, 
  '{MAPS_DIR}/NCHA_map_2011to2015.yaml' %>% glue()
)


create_latex_crosstabs(
  data.frame(
    NQ47 = ncha_F11_S15_df_list[['base_df']][[original_var]], 
    Q47_gender = ncha_F11_S15_df_list[['study_df']][[new_var]]
  ), 
  original_var, new_var
)
```

```{r}
orig_var_na <- is.na(ncha_F11_S15_df_list[['base_df']][[original_var]])
new_var_na <- is.na(ncha_F11_S15_df_list[['study_df']][[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

**`RNQ47A`** and **`RNQ47B`** vs. **`Q47_gender`** (F15-S19)

```{r, results='asis', message=FALSE, warning=FALSE}
# 2015 - 2019 data 
ncha_F15_S19 <- load_and_prep_NCHA_file(
  "{DATA_DIR}/NCHA-II/NCHA-II_F15_S19.sav" %>% glue()
)
ncha_F15_S19_df_list <- create_study_datasets(
  ncha_F15_S19, 
  '{MAPS_DIR}/NCHA_map_2015to2019.yaml' %>% glue()
)

# The code below is taken directly from the processing script
# I am effectively re-creating the data re-coding process here
# I target the "study_df" here though not the "base_df" 
ncha_F15_S19_df_list[["study_df"]] <- ncha_F15_S19_df_list[["study_df"]] %>% 
  mutate(
    Q47_gender = ifelse(Q47_trans == "Yes", "Transgender", Q47_sex)
  )

original_var <- "RNQ47A"
new_var <- "Q47_gender"

create_latex_crosstabs(
  data.frame(
    RNQ47A = ncha_F15_S19_df_list[['base_df']][[original_var]], 
    Q47_gender = ncha_F15_S19_df_list[['study_df']][[new_var]]
  ), 
  original_var, new_var
)
```

```{r, results='asis'}
original_var <- "RNQ47B"
new_var <- "Q47_gender"

create_latex_crosstabs(
  data.frame(
    RNQ47B = ncha_F15_S19_df_list[['base_df']][[original_var]], 
    Q47_gender = ncha_F15_S19_df_list[['study_df']][[new_var]]
  ), 
  original_var, new_var
)
```

There is a slight difference in the totals when examining the sets of crosstabs. This discrepancy can be explained by the fact that we gave "priority" to the trans variable when creating a compatible 3-category gender variable from the 2015 to 2019 data. There are 43 participants with missing values on the available measure of biological sex (`RQN47A`) that responded yes to the measure of transgender identity (`RQN47B`). 

```{r, results='asis'}
ncha_F15_S19_df_list[['base_df']] %>% 
  select(RNQ47A, RNQ47B) %>% 
  mutate(
    sex_na = is.na(RNQ47A), 
    trans_yes = RNQ47B == "2"
  ) %>% 
  select(sex_na, trans_yes) %>%
  table() %>% 
  as.data.frame.matrix() %>% 
  stargazer::stargazer(
    column.sep.width = "1pt", 
    font.size = "footnotesize", 
    summary = FALSE, 
    header = FALSE, 
    rownames = TRUE
  )
```

Given the three-way variable creation of a final measure here, a bivariate comparison of missing values does not make much sense. The exploration of the results from each survey design and their aggregation should be sufficient. 


```{r, results='asis'}
stargazer::stargazer(
  table(complete_df[['Q47_gender']]) %>% 
    data.frame(), 
  column.sep.width = "1pt", 
  font.size = "footnotesize", 
  summary = FALSE, 
  header = FALSE, 
  rownames = FALSE
)
```

The total for each category in the final gender variable in our `complete_df` are exactly what we would expect if we summed the totals from each of the three surveys. 

## Enrollment status (`NQ52`)

A variable that tracks a student's enrollment status. Options are "Full-time", "Part-time" and "Other". 

New Variables: 

- `Q52_enrollment`: a character variable with the three response options ("Full-time", "Part-time", and "Other") encoded as strings as opposed to the raw number mappings in the original data set. Missingness should be preserved. 

```{r, results='asis'}
original_var <- "NQ52"
new_var <- "Q52_enrollment"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## International students (`NQ55`)

A dichotomous indicator that tracks whether a student is from a foreign country. 

New Variables: 

- `Q55_international`: a character variable with the two response options ("Yes"/"No") encoded as strings as opposed to the raw number mappings in the original data set. Missingness should be preserved. 

```{r, results='asis'}
original_var <- "NQ55"
new_var <- "Q55_international"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Survey method (`pwno`)

This variable tracks the format the respondent used to provide their responses. The vast majority completed the survey online. There were some though who relied on paper surveys. 

New Variables: 

- `survey_method`: a character vector that tracks survey modality - either "Paper" or "Web." Missingness should be preserved.

```{r, results='asis'}
original_var <- "pwno"
new_var <- "survey_method"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## Public or Private School (`PUBPRIV`)

A dichotomous indicator that tracks whether the student's school is private or public. 

New Variables: 

- `public_schl`: a binary (0, 1) indicator. Observations from public schools were assigned a value of 1. Private schools were assigned a value of 0. 

```{r, results='asis'}
original_var <- "PUBPRIV"
new_var <- "public_schl"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

## School total enrollment (`size`)

An ordinal variable with five enrollment "buckets". 

New Variables: 

- `school_size`: a character variable that contains the strings for each response option (see below). Should retain missingness.

```{r, results='asis'}
original_var <- "size"
new_var <- "school_size"
create_latex_crosstabs(complete_df, original_var, new_var)
```

```{r}
orig_var_na <- is.na(complete_df[[original_var]])
new_var_na <- is.na(complete_df[[new_var]])
testthat::expect_equal(new_var_na, orig_var_na)
```

\pagebreak

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('rmarkdown', 'tidyverse', 'stargazer', 'haven', 'yaml'), file = 'NCHA_data_QA.bib')
```

# Packages Used